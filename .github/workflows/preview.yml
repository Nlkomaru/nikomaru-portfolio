name: Preview

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  check:
    runs-on: ubuntu-latest
    name: Check
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: ./pnpm-lock.yaml

      - name: Install
        run: pnpm install

      - name: Check
        run: pnpm run check

  deploy-app-preview:
    needs: check
    env:
      CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
      R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
    runs-on: ubuntu-latest
    name: Deploy App Preview
    outputs:
      deployment_url: ${{ steps.resolve-app-preview-url.outputs.deployment_url }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: ./pnpm-lock.yaml

      - name: Install
        run: pnpm install

      - name: Build app
        run: pnpm run build

      - name: Deploy app preview
        id: deploy-preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_KEY }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: versions upload --message "Deployed preview by GitHub Actions branch ${{ github.ref_name }}"
          workingDirectory: app

      - name: Resolve app preview URL
        id: resolve-app-preview-url
        env:
          WRANGLER_DEPLOYMENT_URL: ${{ steps.deploy-preview.outputs.deployment-url }}
          WRANGLER_COMMAND_OUTPUT: ${{ steps.deploy-preview.outputs.command-output }}
          WRANGLER_COMMAND_STDERR: ${{ steps.deploy-preview.outputs.command-stderr }}
        shell: bash
        run: |
          url="$WRANGLER_DEPLOYMENT_URL"
          if [ -z "$url" ]; then
            output="$WRANGLER_COMMAND_OUTPUT"$'\n'"$WRANGLER_COMMAND_STDERR"
            url=$(echo "$output" | grep -Eo 'https://[^[:space:]]+' | head -n 1 || true)
          fi

          if [ -z "$url" ]; then
            echo "Failed to resolve app preview URL from wrangler-action outputs."
            exit 1
          fi

          echo "deployment_url=$url" >> "$GITHUB_OUTPUT"

  deploy-storybook-preview:
    needs: check
    runs-on: ubuntu-latest
    name: Deploy Storybook Preview
    outputs:
      deployment_url: ${{ steps.resolve-storybook-preview-url.outputs.deployment_url }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: ./pnpm-lock.yaml

      - name: Install
        run: pnpm install

      - name: Build storybook
        run: pnpm --filter ./storybook build

      - name: Deploy storybook preview
        id: deploy-storybook-preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_KEY }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: versions upload --message "Deployed storybook preview by GitHub Actions branch ${{ github.ref_name }}"
          workingDirectory: storybook

      - name: Resolve storybook preview URL
        id: resolve-storybook-preview-url
        env:
          WRANGLER_DEPLOYMENT_URL: ${{ steps.deploy-storybook-preview.outputs.deployment-url }}
          WRANGLER_COMMAND_OUTPUT: ${{ steps.deploy-storybook-preview.outputs.command-output }}
          WRANGLER_COMMAND_STDERR: ${{ steps.deploy-storybook-preview.outputs.command-stderr }}
        shell: bash
        run: |
          url="$WRANGLER_DEPLOYMENT_URL"
          if [ -z "$url" ]; then
            output="$WRANGLER_COMMAND_OUTPUT"$'\n'"$WRANGLER_COMMAND_STDERR"
            url=$(echo "$output" | grep -Eo 'https://[^[:space:]]+' | head -n 1 || true)
          fi

          if [ -z "$url" ]; then
            echo "Failed to resolve storybook preview URL from wrangler-action outputs."
            exit 1
          fi

          echo "deployment_url=$url" >> "$GITHUB_OUTPUT"

  lighthouse-app:
    needs: deploy-app-preview
    runs-on: ubuntu-latest
    name: Lighthouse (App only)
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: ./pnpm-lock.yaml

      - name: Install
        run: pnpm install

      - name: Build Lighthouse URL list
        env:
          DEPLOYMENT_URL: ${{ needs.deploy-app-preview.outputs.deployment_url }}
        run: |
          node .github/workflows/scripts/lighthouse-build-urls.mjs

      - name: Run Lighthouse
        run: |
          ./.github/workflows/scripts/lighthouse-run.sh lighthouse-urls.txt lighthouse 6 3

      - name: Summarize Lighthouse
        continue-on-error: true
        run: |
          node .github/workflows/scripts/lighthouse-summarize.mjs

      - name: Upload Lighthouse summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-summary
          path: lighthouse-summary.md

  comment:
    needs: [deploy-app-preview, deploy-storybook-preview, lighthouse-app]
    runs-on: ubuntu-latest
    name: Comment Preview URLs
    steps:
      - uses: actions/checkout@v4

      - name: Download Lighthouse summary
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-summary
          path: .

      - name: Create comment file
        env:
          APP_PREVIEW_URL: ${{ needs.deploy-app-preview.outputs.deployment_url }}
          STORYBOOK_PREVIEW_URL: ${{ needs.deploy-storybook-preview.outputs.deployment_url }}
        run: |
          cat << EOF > comment.md
          ## Deploy preview
          - App Preview URL: $APP_PREVIEW_URL
          - Storybook Preview URL: $STORYBOOK_PREVIEW_URL
          EOF

          if [ -f lighthouse-summary.md ]; then
            cat lighthouse-summary.md >> comment.md
          fi

      - name: Create PR comment
        run: gh pr comment ${{ github.event.number }} --body-file comment.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
